<div class="container mt-3 ">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <div class="d-flex mb-3 align-items-center">
      <% if current_user.image.blank? %>
        <%= link_to edit_user_registration_path do %>
          <%= image_tag 'no_profile_image_logo.png', size:'48x48', class:'rounded-circle mr-3' %>
        <% end %>
      <% else %>
        <%= cl_image_tag current_user.image, height: 48, width: 48, crop: :fill, class:'rounded-circle mr-3' %>
      <% end %>
        <div>
          <h4 class="mb-0">
            <%= link_to edit_user_registration_path do %>
              <%= current_user.nickname.blank? ? 'ニックネーム未設定' : current_user.nickname %>
            <% end %>さんのクラログ
          </h4>
          <% if current_user.nickname.blank? %>
            <div class="mb-3">ニックネームは<%= link_to 'アカウント設定', edit_user_registration_path %>から設定/変更できます。</div>
          <% end %>
        </div>
      </div>
      <div class="card px-2 py-3 mt-1">
        <div>最後に登った日：
          <span style="font-size: 1.2rem;">
            <%= @routes.joins(:logs).order(date: 'DESC').first.logs.order(date: 'DESC').first.date if @routes.exists? & current_user.logs.exists? %>
          </span>
        </div>
        <div>累計完登本数：
          <% sent_count = 0 %>
          <% @routes.each do |route| %>
            <% sent_count += 1 if route.sent %>
          <% end %>
          <%= sent_count %>
        </div>
        <div>累計クライミング日数：
          <%= current_user.routes.joins(:logs).count('DISTINCT date') if @routes.exists? & current_user.logs.exists? %>
        </div>
      </div>

      <div class="card px-2 py-3 mt-1">
        <div>ボルダー最高グレード：
          <% boulder =  current_user.routes.joins(:logs).where('category_id = ? and logs.status_id < ?', 1, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').first if @routes.exists? %>
          <% unless boulder.nil? %>
            <%= link_to route_path(boulder) do %>
            <%= "#{boulder.combined_grade} (#{boulder.logs.where('status_id < ?', 4).first.date} #{boulder.gym.name})" %>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="card px-2 py-3 mt-1">
        <div class="mb-1">リード最高グレード：
          <% lead = current_user.routes.joins(:logs).where('category_id = ? and logs.status_id < ?', 2, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').first if @routes.exists? %>
          <% unless lead.nil? %>
            <%= link_to route_path(lead) do %>
              <%= "#{lead.combined_grade} (#{lead.logs.where('status_id < ?', 4).first.date} #{lead.gym.name})" %>
            <% end %>
          <% end %>
        </div>
      </div>

      <div class="mt-3 text-center">
        <%= link_to '今日', logs_path(period: 'today') %> |
        <%= link_to '今週', logs_path(period: 'thisweek') %> |
        <%= link_to '今月', logs_path(period: 'thismonth') %> |
        <%= link_to '今年', logs_path(period: 'thisyear') %> |
        <%= link_to '昨年', logs_path(period: 'lastyear') %> |
        <%= link_to '全期間', logs_path %>
      <h5 class="mt-3 pl-1 mb-1">日別トライ本数</h5>
      <div class="mb-3">
        <%= column_chart current_user.routes.joins(:logs).group_by_day(:date).count,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
            library: {scales: {xAxes: [{ticks: {padding: 8},
                                        gridLines: {drawTicks: false}}],
                               yAxes: [{ticks: {suggestedMax: 15, stepSize: 5}, gridLines: {display:false}}]
                              }
                     },
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>

      <h5 class="mt-3 pl-1 mb-1">ボルダー完登数</h5>
      <% boulders_by_grade = {} %>
        <% Grade.where(grade_type: 'ボルダー').each do |grade| %>
        <% boulders_by_grade[grade.grade] = 0 %>
      <% end %>
      <% sents = current_user.routes.joins(:grade).joins(:logs).select('grades.grade').where('routes.category_id = ? AND logs.status_id < ?', 1, 4 ).group('grades.grade').count %>
      <% boulders_by_grade =  boulders_by_grade.merge(sents) %>
      <div class="mb-3">
        <%= bar_chart boulders_by_grade,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
           library: {scales: {
                        xAxes: [{ticks: {suggestedMax: 10, stepSize: 1, padding: 8}, gridLines: {drawTicks: false}}],
                        yAxes: [{gridLines: {display:false}}]
                        }
                      },
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>

      <h5 class="mt-3 pl-1 mb-1">リード完登数</h5>
      <% leads_by_grade = {} %>
        <% Grade.where(grade_type: 'ルート').each do |grade| %>
        <% leads_by_grade[grade.grade] = 0 %>
      <% end %>
      <% sents = current_user.routes.joins(:grade).joins(:logs).select('grades.grade').where('routes.category_id = ? AND logs.status_id < ?', 2, 4).group('grades.grade').count %>
      <% leads_by_grade =  leads_by_grade.merge(sents) %>
      <div class="mb-3">
        <%= bar_chart leads_by_grade,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
            library: {scales: {
                        xAxes: [{ticks: {suggestedMax: 10, stepSize: 1, padding: 8}, gridLines: {drawTicks: false}}],
                        yAxes: [{gridLines: {display:false}}]
                        }
                      },
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>

    </div>
  </div>
</div>
