<div class="container mt-3 ">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <div class="d-flex mb-1 align-items-center">
      <% if current_user.image.blank? %>
        <%= link_to edit_user_registration_path do %>
          <%= image_tag 'no_profile_image_logo.png', size:'40x40', class:'rounded-circle mr-3' %>
        <% end %>
      <% else %>
        <%= cl_image_tag current_user.image, height: 40, width: 40, crop: :fill, class:'rounded-circle mr-3' %>
      <% end %>
        <div>
          <h4 class="mb-0">
            <%= link_to edit_user_registration_path do %>
              <%= current_user.nickname.blank? ? 'ニックネーム未設定' : current_user.nickname %>
            <% end %>さんのクラログ
          </h4>
        </div>
      </div>
      <div>

      </div>
      <div class="mt-1 date_select_menu text-left">
          <%= active_link_to '全期間', logs_path, active: :exact %>|
          <%= active_link_to '今年', logs_path(from: Date.today.beginning_of_year, to: Date.today.end_of_year), active: :exact %>|
          <%= active_link_to '今月', logs_path(from: Date.today.beginning_of_month, to: Date.today.end_of_month), active: :exact %>|
          <%= active_link_to '今週', logs_path(from: Date.today.beginning_of_week, to: Date.today.end_of_week), active: :exact %>|
          <%= active_link_to '今日', logs_path(from: Date.today, to: Date.today), active: :exact %>
      </div>
      <div class="text-left mb-1">
        <%= @from.strftime("%Y年%m月%d日(#{%w(日 月 火 水 木 金 土)[@from.wday]})") %> 〜 <%= @to.strftime("%Y年%m月%d日(#{%w(日 月 火 水 木 金 土)[@to.wday]})")  %>
      </div>

      <div class="card px-2 pt-1 pb-0 mt-1">
        <div>完登本数：
          <%= @logs.where('status_id < ?', 4).count %>
        </div>
        <div>クライミング日数：
          <%= @logs.count('DISTINCT date') if @logs.exists? %>
        </div>
        <div>ボルダー最高グレード：
          <% boulder_best_log =  @logs.joins(:route).where('routes.category_id = ? and logs.status_id < ?', 1, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').order(date: 'DESC').first if @logs.exists? %>
          <% unless boulder_best_log.nil? %>
            <%= link_to route_path(boulder_best_log.route) do %>
            <%= "#{boulder_best_log.route.combined_grade} (#{boulder_best_log.date} #{boulder_best_log.route.gym.name})" %>
            <% end %>
          <% end %>
        </div>
        <div class="mb-1">リード最高グレード：
          <% lead_best_log =  @logs.joins(:route).where('routes.category_id = ? and logs.status_id < ?', 2, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').order(date: 'DESC').first if @logs.exists? %>
          <% unless lead_best_log.nil? %>
            <%= link_to route_path(lead_best_log.route) do %>
            <%= "#{lead_best_log.route.combined_grade} (#{lead_best_log.date} #{lead_best_log.route.gym.name})" %>
            <% end %>
          <% end %>
        </div>
      </div>
      <h5 class="mt-3 pl-1 mb-1">日別トライ本数</h5>
      <div class="mb-3">
        <%= column_chart @logs.group_by_day(:date).count,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
            library: {animation: {easing: 'easeOutQuad',"duration": 1000},
                      scales: {xAxes: [{ticks: {padding: 8},
                                        gridLines: {drawTicks: false}}],
                               yAxes: [{ticks: {suggestedMax: 15, stepSize: 5}, gridLines: {display:false}}]
                              }
                     },
            suffix: "本",
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>

      <h5 class="mt-3 pl-1 mb-1">ボルダー完登数</h5>
      <% boulders_by_grade = {} %>
        <% Grade.where(grade_type: 'ボルダー').each do |grade| %>
        <% boulders_by_grade[grade.grade] = 0 %>
      <% end %>
      <% sents = @logs.joins(:route).joins(:grade).select('grades.grade').where('routes.category_id = ? AND logs.status_id < ?', 1, 4 ).group('grades.grade').count %>
      <% boulders_by_grade =  boulders_by_grade.merge(sents) %>
      <div class="mb-3">
        <%= bar_chart boulders_by_grade,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
            library: {animation: {easing: 'easeOutQuad',"duration": 1000},
                      scales: {
                        xAxes: [{ticks: {suggestedMax: 10, stepSize: 5, padding: 8}, gridLines: {drawTicks: false}}],
                        yAxes: [{gridLines: {display:false}}]
                        }
                      },
            suffix: "本",
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>

      <h5 class="mt-3 pl-1 mb-1">リード完登数</h5>
      <% leads_by_grade = {} %>
        <% Grade.where(grade_type: 'ルート').each do |grade| %>
        <% leads_by_grade[grade.grade] = 0 %>
      <% end %>
      <% sents = @logs.joins(:route).joins(:grade).select('grades.grade').where('routes.category_id = ? AND logs.status_id < ?', 2, 4 ).group('grades.grade').count %>
      <% leads_by_grade =  leads_by_grade.merge(sents) %>
      <div class="mb-3">
        <%= bar_chart leads_by_grade,
            points: false,
            colors: ["#167FFB", "#666"],
            dataset: {borderWidth: 0},
            library: {animation: {easing: 'easeOutQuad',"duration": 1000},
                      scales: {
                        xAxes: [{ticks: {suggestedMax: 10, stepSize: 5, padding: 8}, gridLines: {drawTicks: false}}],
                        yAxes: [{gridLines: {display:false}}]
                        }
                      },
            suffix: "本",
            height: "200px",
            messages: {empty: "データがありません"} %>
      </div>
      <h5 class="mt-3 pl-1 mb-1">日別ボルダー最高グレード</h5>
      <canvas id="myChart" width="400" height="150"></canvas>
    </div>
  </div>
</div>


<% best_boulder_grade_by_date = @logs.joins(:route).where('routes.category_id = ? AND logs.status_id < ?', 1, 4).group(:date).maximum('routes.grade_id') %>
<% @labels = best_boulder_grade_by_date.keys %>
<% @datas = best_boulder_grade_by_date.values %>

<script>
var ctx = document.getElementById("myChart").getContext('2d');
var myChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: <%= @labels.to_json.html_safe %>,
        datasets: [{
            label: "サンプル",
            data: <%= @datas.to_json.html_safe %>,
            backgroundColor: 'rgba(22, 127, 251, 0.6)',
            borderColor: 'rgba(22, 127, 251, 0.6)',
            fill: false
        }]
    },
    options: {
        title:  {
          display: false,
        },
        legend: {
          display: false //凡例の削除 → 全てのグラフ
        },
        scales: {
            xAxes: [{
                type: 'time',
                distribution: 'linear',
                gridLines: {display:false}
            }],
            yAxes: [{
                ticks: {
                    // Include a dollar sign in the ticks
                    callback: function(value, index, values) {
                        switch(value) {
                          case 0:
                            return '9級';
                          case 1:
                            return '8級';
                          case 2:
                            return '7級';
                          case 3:
                            return '6級';
                          case 4:
                            return '5級';
                          case 5:
                            return '4級';
                          case 6:
                            return '3級';
                          case 7:
                            return '2級';
                          case 8:
                            return '1級';
                          case 9:
                            return '初段';
                          case 10:
                            return '2段';
                          case 11:
                            return '3段';
                          case 12:
                            return '4段';
                          case 13:
                            return '5段';
                        }
                    }
                }
            }]
        }
    }
});
</script>
