<div class="container mt-3">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 mb-5 pb-3">
      <h4><%= @gym.name %></h4>
      <% if current_user.admin %>
        <%= link_to 'ジム情報変更', edit_gym_path(@gym) %>
      <% end %>
      <div class="card px-2 py-1 mt-1">
        <div>最終訪問日：
          <%= @gym.routes.joins(:logs).where('user_id = ?', current_user).order(date: 'DESC').first.logs.order(date: 'DESC').first.date if current_user.logs %>
        </div>
        <div>完登本数：
          <% sent_count = 0 %>
          <% @gym.routes.where('user_id = ?', current_user).each do |route| %>
            <% sent_count += 1 if route.sent %>
          <% end %>
          <%= sent_count %>
        </div>
        <div>累計訪問日数：
          <%= @gym.routes.joins(:logs).where('user_id = ?', current_user).count('DISTINCT date') if @gym.routes.exists? %>
        </div>
        <div>ボルダー最高グレード：
          <% boulder =  @gym.routes.joins(:logs).where('user_id = ? and category_id = ? and logs.status_id < ?', current_user, 1, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').first if @gym.routes.exists? %>
          <% unless boulder.nil? %>
            <%= link_to route_path(boulder) do %>
              <%= "#{boulder.combined_grade} (#{boulder.logs.where('status_id < ?', 4).first.date})" unless boulder.nil?  %>
            <% end %>
          <% end %>
          </div>
        <div class="mb-1">リード最高グレード：
          <% lead = @gym.routes.joins(:logs).where('user_id = ? and category_id = ? and logs.status_id < ?', current_user, 2, 4).order(grade_id: 'DESC').order(sub_grade_id: 'DESC').first if @gym.routes.exists? %>
          <% unless lead.nil? %>
            <%= link_to route_path(lead) do %>
              <%= "#{lead.combined_grade} (#{lead.logs.where('status_id < ?', 4).first.date})"%>
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="my-3 date_select_menu text-center">
        <%= active_link_to '全期間', gym_path(@gym), active: :exact, class:'date_select_menu'  %>|
        <%= active_link_to '今年', gym_path(@gym, period: 'thisyear'), active: :exact %>|
        <%= active_link_to '先月', gym_path(@gym, period: 'lastmonth'), active: :exact %>|
        <%= active_link_to '今月', gym_path(@gym, period: 'thismonth'), active: :exact %>|
        <%= active_link_to '今週', gym_path(@gym, period: 'thisweek'), active: :exact %>|
        <%= active_link_to '今日', gym_path(@gym, period: 'today'), active: :exact %>

      </div>
        <% @routes.each do |route| %>
          <div class="card my-2">
            <div class="d-flex">
              <div>
                <% if route.image.blank? %>
                  <%= link_to edit_route_path(route) do %>
                    <%= image_tag 'no_image_logo.png', size:'80x80', class:'rounded mr-3' %>
                  <% end %>
                <% else %>
                  <%= cl_image_tag route.image, height: 80, width: 80, crop: :fill, class:"rounded mr-3" %>
                <% end %>
              </div>
              <div>
                <div>
                  <span style="font-size: 1.1rem;">
                    <%= Category.find_by(id:route.category_id).category %>
                    <%= route.combined_grade %>
                  </span>
                  <%= route.route_type %>
                  <%= route.route_name %>
                  <%= link_to '詳細', route_path(route) %>
                </div>
                <div>
                  <%= route.comment %>
                </div>
                <div>
                  <%= route.latest_log_date if route.logs.exists? %>
                  <%= route.best_status %>
                  <%= route.logs.count %>トライ
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<div class="container fixed-bottom">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <%= link_to '課題を追加', new_gym_route_path(@gym), class:'btn btn-primary btn-lg btn-block mb-3' %>
    </div>
  </div>
</div>

